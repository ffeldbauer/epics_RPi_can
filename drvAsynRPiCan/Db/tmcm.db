#################################################
# ###                                       ### #
# ### EPICS Database for                    ### #
# ###   TMCM 142 IF                         ### #
# ###                                       ### #
# ### author: F.Feldbauer                   ### #
# ###                                       ### #
# ### Ref 1.0; 2013-01-07                   ### #
# ###                                       ### #
# ### macros: subsys  PANDA subsystem       ### #
# ###         BUS     AsynPort              ### #
#################################################

# TMCM Status message
# This record is updated after each read or write command
record( mbbi, "PANDA:$(subsys):MOTOR:STATUS" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),0,1)TMCM142_STATUS" )
  field( SCAN, "I/O Intr" )

  # State values
  field( ZRVL, "100" )
  field( ONVL, "101" )
  field( TWVL, "1" )
  field( THVL, "2" )
  field( FRVL, "3" )
  field( FVVL, "4" )
  field( SXVL, "5" )
  field( SVVL, "6" )

  # State strings
  field( ZRST, "Successfully executed, no error" )
  field( ONST, "Command loaded into TMCL program EEPROM" )
  field( TWST, "Wrong checksum" )
  field( THST, "Invalid command" )
  field( FRST, "Wrong type" )
  field( FVST, "Invalid value" )
  field( SXST, "Configuration EEPROM locked" )
  field( SVST, "Command not available" )

  # State severities
  field( ZRSV, "NO_ALARM" )
  field( ONSV, "NO_ALARM" )
  field( TWSV, "MAJOR" )
  field( THSV, "MAJOR" )
  field( FRSV, "MAJOR" )
  field( FVSV, "MAJOR" )
  field( SXSV, "MAJOR" )
  field( SVSV, "MAJOR" )

}

# Move to an absolute position
record( longout, "PANDA:$(subsys):MOTOR:MVP:ABS" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),0,1)TMCM142_MVP" )
  # Limits 
  field( DRVH, "+2147483647" )
  field( DRVL, "-2147483648" )
  # Display
  field( EGU,  "usteps" )
  field( HOPR, "+2147483647" )
  field( LOPR, "-2147483648" )
}

# set current position
record( longout, "PANDA:$(subsys):MOTOR:SAP:ACTUALPOSITION" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),1,1)TMCM142_SAP" )
  # Limits 
  field( DRVH, "+2147483647" )
  field( DRVL, "-2147483648" )
  # Display
  field( EGU,  "usteps" )
  field( HOPR, "+2147483647" )
  field( LOPR, "-2147483648" )
}

# set max positioning speed
record( longout, "PANDA:$(subsys):MOTOR:SAP:MAXSPEED" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),4,1)TMCM142_SAP" )
  # Limits 
  field( DRVH, "+2147483647" )
  field( DRVL, "0" )
  # Display
  field( EGU,  "usteps/s" )
  field( HOPR, "+2147483647" )
  field( LOPR, "0" )
}

# Set max acceleration and deceleration
record( longout, "PANDA:$(subsys):MOTOR:SAP:MAXACCELERATION" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),5,1)TMCM142_SAP" )
  # Limits 
  field( DRVH, "16777215" )
  field( DRVL, "1" )
  # Display
  field( EGU,  "usteps/s/s" )
  field( HOPR, "16777215" )
  field( LOPR, "1" )
}

# Set "right limit switch disable"
record( bo, "PANDA:$(subsys):MOTOR:SAP:RIGHTLIMITSWITCH" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),12,1)TMCM142_SAP" )
  field( ONAM, "Enabled" )
  field( ZNAM, "Disabled" )
}

# Set "left limit switch disable"
record( bo, "PANDA:$(subsys):MOTOR:SAP:LEFTLIMITSWITCH" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),13,1)TMCM142_SAP" )
  field( ONAM, "Enabled" )
  field( ZNAM, "Disabled" )
}

# Set stop deceleration
record( longout, "PANDA:$(subsys):MOTOR:SAP:STOPDECELERATION" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),15,1)TMCM142_SAP" )
  # Limits 
  field( DRVH, "16777215" )
  field( DRVL, "1" )
  # Display
  field( EGU,  "usteps/s/s" )
  field( HOPR, "16777215" )
  field( LOPR, "1" )
}

# Set switch mode
record( mbboDirect, "PANDA:$(subsys):MOTOR:SAP:SWITCHMODE" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),27,1)TMCM142_SAP" )
}

# Set µstep resolution
record( mbbo, "PANDA:$(subsys):MOTOR:SAP:USTEPRESOLUTION" ) {
  field( DTYP, "asynUInt32" )
  field( OUT,  "@asyn($(BUS),27,1)TMCM142_SAP" )

  field( ZRST, "2048 micro steps" )
  field( ONST, "1024 micro steps" )
  field( TWST, "512 micro steps" )
  field( THST, "256 micro steps" )
  field( FRST, "128 micro steps" )
  field( FVST, "64 micro steps" )
  field( SXST, "32 micro steps" )
  field( SVST, "16 micro steps" )
  field( EIST, "8 micro steps" )
  field( NIST, "4 micro steps" )
  field( TEST, "2 micro steps" )
  field( ELST, "1 micro steps" )
}

######################################################################

# Get current position
record( longin, "PANDA:$(subsys):MOTOR:SAP:ACTUALPOSITION:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),1,1)TMCM142_GAP" )
  # Display
  field( EGU,  "usteps" )
  field( HOPR, "+2147483647" )
  field( LOPR, "-2147483648" )
}

# Get max positioning speed
record( longin, "PANDA:$(subsys):MOTOR:SAP:MAXSPEED:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),4,1)TMCM142_GAP" )
  # Display
  field( EGU,  "usteps/s" )
  field( HOPR, "+2147483647" )
  field( LOPR, "0" )
}

# Get max acceleration and deceleration
record( longin, "PANDA:$(subsys):MOTOR:SAP:MAXACCELERATION:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),5,1)TMCM142_GAP" )
  # Limits 
  field( DRVH, "16777215" )
  field( DRVL, "1" )
  # Display
  field( EGU,  "usteps/s/s" )
  field( HOPR, "16777215" )
  field( LOPR, "1" )
}

# Get "right limit switch disable"
record( bi, "PANDA:$(subsys):MOTOR:SAP:RIGHTLIMITSWITCH:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),12,1)TMCM142_GAP" )
  field( ONAM, "Enabled" )
  field( ZNAM, "Disabled" )
}

# Get "left limit switch disable"
record( bi, "PANDA:$(subsys):MOTOR:SAP:LEFTLIMITSWITCH:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),13,1)TMCM142_GAP" )
  field( ONAM, "Enabled" )
  field( ZNAM, "Disabled" )
}

# Get stop deceleration
record( longin, "PANDA:$(subsys):MOTOR:SAP:STOPDECELERATION:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),15,1)TMCM142_GAP" )
  # Display
  field( EGU,  "usteps/s/s" )
  field( HOPR, "16777215" )
  field( LOPR, "1" )
}

# Get switch mode
record( mbbiDirect, "PANDA:$(subsys):MOTOR:SAP:SWITCHMODE:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),27,1)TMCM142_GAP" )
}
# 
#record( bi, "PANDA:$(subsys):MOTOR:SAP:SWITCHMODE:R:B2" ) {
#  field( INP,  "PANDA:$(subsys):MOTOR:SAP:SWITCHMODE:R.B2" )
#  field( ONAM, "" )
#  field( ZNAM, "" )
#}


# Get µstep resolution
record( mbbi, "PANDA:$(subsys):MOTOR:SAP:USTEPRESOLUTION:R" ) {
  field( DTYP, "asynUInt32" )
  field( INP,  "@asyn($(BUS),27,1)TMCM142_GAP" )

  field( ZRST, "2048 micro steps" )
  field( ONST, "1024 micro steps" )
  field( TWST, "512 micro steps" )
  field( THST, "256 micro steps" )
  field( FRST, "128 micro steps" )
  field( FVST, "64 micro steps" )
  field( SXST, "32 micro steps" )
  field( SVST, "16 micro steps" )
  field( EIST, "8 micro steps" )
  field( NIST, "4 micro steps" )
  field( TEST, "2 micro steps" )
  field( ELST, "1 micro steps" )
}
